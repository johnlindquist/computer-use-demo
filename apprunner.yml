version: 1.0
runtime: python3
build:
  commands:
    # Install system dependencies
    - apt-get update
    - apt-get install -y xvfb xterm xdotool scrot imagemagick sudo mutter x11vnc
    - apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev
    - apt-get install -y libsqlite3-dev curl git libncursesw5-dev xz-utils tk-dev
    - apt-get install -y libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
    - apt-get install -y net-tools netcat software-properties-common
    - add-apt-repository ppa:mozillateam/ppa
    - apt-get install -y --no-install-recommends libreoffice firefox-esr x11-apps xpdf
    - apt-get install -y --no-install-recommends gedit xpaint tint2 galculator pcmanfm unzip
    
    # Install noVNC
    - git clone --branch v1.5.0 https://github.com/novnc/noVNC.git /opt/noVNC
    - git clone --branch v0.12.0 https://github.com/novnc/websockify /opt/noVNC/utils/websockify
    - ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html
    
    # Install Python dependencies
    - pip install -r computer_use_demo/requirements.txt

run:
  runtime-version: 3.11.6
  command: ./entrypoint.sh
  network:
    port: 8080
  env:
    - name: WIDTH
      value: "1024"
    - name: HEIGHT
      value: "768"
    - name: DISPLAY_NUM
      value: "1"
    - name: DEBIAN_FRONTEND
      value: "noninteractive"
    - name: DEBIAN_PRIORITY
      value: "high"

health-check:
  command: curl -f http://localhost:8080 || exit 1
  interval: 30
  timeout: 5
  retries: 3
  start-period: 60 